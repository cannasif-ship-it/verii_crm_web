import { type ReactElement } from 'react';
import { useTranslation } from 'react-i18next';
import { useNavigate } from 'react-router-dom';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Button } from '@/components/ui/button';
import { ApprovalStatusBadge } from '@/features/approval/components/ApprovalStatusBadge';
import type { ApprovalStatus } from '@/features/approval/types/approval-types';
import { useQuotationList } from '../hooks/useQuotationList';
import { useCreateRevisionOfQuotation } from '../hooks/useCreateRevisionOfQuotation';
import type { QuotationGetDto } from '../types/quotation-types';
import type { PagedFilter } from '@/types/api';
import { formatCurrency } from '../utils/format-currency';
import { ChevronUp, ChevronDown, ChevronsUpDown } from 'lucide-react';

interface QuotationTableProps {
  pageNumber: number;
  pageSize: number;
  sortBy?: string;
  sortDirection?: 'asc' | 'desc';
  filters?: PagedFilter[] | Record<string, unknown>;
  onPageChange: (page: number) => void;
  onSortChange: (sortBy: string, sortDirection: 'asc' | 'desc') => void;
  onRowClick: (quotationId: number) => void;
}

export function QuotationTable({
  pageNumber,
  pageSize,
  sortBy = 'Id',
  sortDirection = 'desc',
  filters = {},
  onPageChange,
  onSortChange,
  onRowClick,
}: QuotationTableProps): ReactElement {
  const { t, i18n } = useTranslation();
  const navigate = useNavigate();
  const createRevisionMutation = useCreateRevisionOfQuotation();

  const { data, isLoading, isFetching } = useQuotationList({
    pageNumber,
    pageSize,
    sortBy,
    sortDirection,
    filters: filters as PagedFilter[] | undefined,
  });

  const handleRevision = async (e: React.MouseEvent, quotationId: number): Promise<void> => {
    e.stopPropagation();
    try {
      const result = await createRevisionMutation.mutateAsync(quotationId);
      if (result.success && result.data?.id) {
        navigate(`/quotations/${result.data.id}`);
      }
    } catch (error) {
    }
  };

  const handleSort = (column: string): void => {
    const newDirection = sortBy === column && sortDirection === 'asc' ? 'desc' : 'asc';
    onSortChange(column, newDirection);
  };

  const SortIcon = ({ column }: { column: string }): ReactElement => {
    if (sortBy !== column) {
      return <ChevronsUpDown className="ml-2 w-3 h-3 opacity-30" />;
    }
    return sortDirection === 'asc' ? (
      <ChevronUp className="ml-2 w-3 h-3 text-pink-600 dark:text-pink-500" />
    ) : (
      <ChevronDown className="ml-2 w-3 h-3 text-pink-600 dark:text-pink-500" />
    );
  };

  if (isLoading || isFetching) {
    return (
      <div className="flex flex-col items-center justify-center py-24 gap-4 border border-zinc-300 dark:border-zinc-700/80 rounded-xl bg-white/50 dark:bg-card/50">
        <div className="w-10 h-10 border-4 border-muted border-t-pink-500 rounded-full animate-spin" />
        <span className="text-muted-foreground animate-pulse text-sm font-medium">
          {t('quotation.loading', 'Yükleniyor...')}
        </span>
      </div>
    );
  }

  const quotations = data?.data || [];

  if (!data || quotations.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-24 text-muted-foreground border border-zinc-300 dark:border-zinc-700/80 border-dashed rounded-xl bg-white/50 dark:bg-card/50">
        <p className="text-sm font-medium">{t('quotation.noData', 'Veri yok')}</p>
      </div>
    );
  }

  const totalPages = Math.ceil((data.totalCount || 0) / pageSize);

  const formatDate = (dateString: string | null | undefined): string => {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString(i18n.language);
  };

  return (
    <>
      <div className="rounded-md border border-zinc-300 dark:border-zinc-700/80 overflow-hidden bg-white/50 dark:bg-card/50">
        <Table>
          <TableHeader>
            <TableRow className="bg-muted/50">
              <TableHead
                className="cursor-pointer select-none"
                onClick={() => handleSort('Id')}
              >
                <div className="flex items-center">
                  {t('quotation.list.id', 'ID')}
                  <SortIcon column="Id" />
                </div>
              </TableHead>
              <TableHead
                className="cursor-pointer select-none"
                onClick={() => handleSort('OfferNo')}
              >
                <div className="flex items-center">
                  {t('quotation.list.offerNo', 'Teklif No')}
                  <SortIcon column="OfferNo" />
                </div>
              </TableHead>
              <TableHead
                className="cursor-pointer select-none"
                onClick={() => handleSort('PotentialCustomerName')}
              >
                <div className="flex items-center">
                  {t('quotation.list.customer', 'Müşteri')}
                  <SortIcon column="PotentialCustomerName" />
                </div>
              </TableHead>
              <TableHead
                className="cursor-pointer select-none"
                onClick={() => handleSort('RepresentativeName')}
              >
                <div className="flex items-center">
                  {t('quotation.list.representative', 'Temsilci')}
                  <SortIcon column="RepresentativeName" />
                </div>
              </TableHead>
              <TableHead
                className="cursor-pointer select-none"
                onClick={() => handleSort('OfferDate')}
              >
                <div className="flex items-center">
                  {t('quotation.list.offerDate', 'Teklif Tarihi')}
                  <SortIcon column="OfferDate" />
                </div>
              </TableHead>
              <TableHead
                className="cursor-pointer select-none"
                onClick={() => handleSort('Currency')}
              >
                <div className="flex items-center">
                  {t('quotation.list.currency', 'Para Birimi')}
                  <SortIcon column="Currency" />
                </div>
              </TableHead>
              <TableHead
                className="cursor-pointer select-none text-right"
                onClick={() => handleSort('GrandTotal')}
              >
                <div className="flex items-center justify-end">
                  {t('quotation.list.grandTotal', 'Genel Toplam')}
                  <SortIcon column="GrandTotal" />
                </div>
              </TableHead>
              <TableHead
                className="cursor-pointer select-none"
                onClick={() => handleSort('Status')}
              >
                <div className="flex items-center">
                  {t('quotation.list.status', 'Durum')}
                  <SortIcon column="Status" />
                </div>
              </TableHead>
              <TableHead className="text-center">
                {t('quotation.list.actions', 'İşlemler')}
              </TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {quotations.map((quotation: QuotationGetDto) => (
              <TableRow
                key={quotation.id}
                className="cursor-pointer hover:bg-muted/50 transition-colors"
                onClick={() => onRowClick(quotation.id)}
              >
                <TableCell className="font-medium">{quotation.id}</TableCell>
                <TableCell>{quotation.offerNo || '-'}</TableCell>
                <TableCell>{quotation.potentialCustomerName || '-'}</TableCell>
                <TableCell>{quotation.representativeName || '-'}</TableCell>
                <TableCell>{formatDate(quotation.offerDate)}</TableCell>
                <TableCell>{quotation.currency || '-'}</TableCell>
                <TableCell className="text-right font-semibold">
                  {formatCurrency(quotation.grandTotal, quotation.currency || 'TRY')}
                </TableCell>
                <TableCell>
                  {typeof quotation.status === 'number' && quotation.status >= 0 && quotation.status <= 4 ? (
                    <ApprovalStatusBadge status={quotation.status as ApprovalStatus} />
                  ) : (
                    <span className="text-muted-foreground text-sm">-</span>
                  )}
                </TableCell>
                <TableCell>
                  {(quotation.status === 0 || quotation.status === 1) && (
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={(e) => handleRevision(e, quotation.id)}
                      disabled={createRevisionMutation.isPending}
                      className="w-full"
                    >
                      {createRevisionMutation.isPending
                        ? t('quotation.loading', 'Yükleniyor...')
                        : t('quotation.list.revise', 'Revize et')}
                    </Button>
                  )}
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>

      <div className="flex items-center justify-between py-4">
        <div className="text-sm text-muted-foreground">
          {t('quotation.list.showing', '{{from}}-{{to}} / {{total}} gösteriliyor', {
            from: (pageNumber - 1) * pageSize + 1,
            to: Math.min(pageNumber * pageSize, data.totalCount || 0),
            total: data.totalCount || 0,
          })}
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={() => onPageChange(pageNumber - 1)}
            disabled={pageNumber <= 1}
          >
            {t('quotation.previous', 'Önceki')}
          </Button>
          <div className="flex items-center px-4 text-sm">
            {t('quotation.list.page', 'Sayfa {{current}} / {{total}}', {
              current: pageNumber,
              total: totalPages,
            })}
          </div>
          <Button
            variant="outline"
            size="sm"
            onClick={() => onPageChange(pageNumber + 1)}
            disabled={pageNumber >= totalPages}
          >
            {t('quotation.next', 'Sonraki')}
          </Button>
        </div>
      </div>
    </>
  );
}
