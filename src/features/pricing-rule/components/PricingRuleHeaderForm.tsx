import { type ReactElement, useState } from 'react';
import { useFormContext } from 'react-hook-form';
import { useTranslation } from 'react-i18next';
import { Input } from '@/components/ui/input';
import {
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { useCustomersForPricingRule } from '../hooks/useCustomersForPricingRule';
import { CustomerSelectDialog, type CustomerSelectionResult } from '@/components/shared';
import { PricingRuleType, type PricingRuleFormSchema } from '../types/pricing-rule-types';
import { Button } from '@/components/ui/button';
import { VoiceSearchCombobox, type ComboboxOption } from '@/components/shared/VoiceSearchCombobox';
// İkonlar
import { 
  Search, 
  List, 
  Hash, 
  Type, 
  Calendar, 
  Building2, 
} from 'lucide-react';

// --- TASARIM SABİTLERİ (Diğer formlarla uyumlu) ---
const INPUT_STYLE = `
  h-12 rounded-xl
  bg-slate-50 dark:bg-[#0f0a18] 
  border border-slate-200 dark:border-white/10 
  text-slate-900 dark:text-white text-sm
  placeholder:text-slate-400 dark:placeholder:text-slate-600 
  
  focus-visible:bg-white dark:focus-visible:bg-[#1a1025]
  focus-visible:border-pink-500 dark:focus-visible:border-pink-500/70
  focus-visible:ring-2 focus-visible:ring-pink-500/10 focus-visible:ring-offset-0
  
  focus:ring-2 focus:ring-pink-500/10 focus:ring-offset-0 focus:border-pink-500
  
  transition-all duration-200
`;

const LABEL_STYLE = "text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide ml-1 mb-2 flex items-center gap-2";

export function PricingRuleHeaderForm(): ReactElement {
  const { t } = useTranslation();
  const form = useFormContext<PricingRuleFormSchema>();
  const { data: customers } = useCustomersForPricingRule();
  const [customerDialogOpen, setCustomerDialogOpen] = useState(false);

  const handleCustomerSelect = (result: CustomerSelectionResult): void => {
    if (result.customerId) {
      form.setValue('customerId', result.customerId);
      form.setValue('erpCustomerCode', null);
    } else if (result.erpCustomerCode) {
      form.setValue('customerId', null);
      form.setValue('erpCustomerCode', result.erpCustomerCode);
    }
  };

  const customerId = form.watch('customerId');
  const erpCustomerCode = form.watch('erpCustomerCode');

  const selectedCustomer = customers?.find((c) => c.id === customerId);
  const displayValue = selectedCustomer
    ? selectedCustomer.name
    : erpCustomerCode
      ? `ERP: ${erpCustomerCode}`
      : '';

  const ruleTypeOptions: ComboboxOption[] = [
    { value: PricingRuleType.Demand.toString(), label: t('pricingRule.ruleType.demand', 'Talep') },
    { value: PricingRuleType.Quotation.toString(), label: t('pricingRule.ruleType.quotation', 'Teklif') },
    { value: PricingRuleType.Order.toString(), label: t('pricingRule.ruleType.order', 'Sipariş') },
  ];

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      
      {/* 1. Kural Temel Bilgileri */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
        <FormField
          control={form.control}
          name="ruleType"
          render={({ field }) => (
            <FormItem>
              <FormLabel className={LABEL_STYLE}>
                <List size={12} className="text-pink-500" />
                {t('pricingRule.header.ruleType', 'Kural Tipi')} *
              </FormLabel>
              <FormControl>
                <VoiceSearchCombobox
                  options={ruleTypeOptions}
                  value={field.value?.toString()}
                  onSelect={(value) => field.onChange(value ? parseInt(value) as PricingRuleType : null)}
                  placeholder={t('pricingRule.header.ruleTypePlaceholder', 'Kural tipi seçin')}
                  searchPlaceholder={t('pricingRule.header.searchRuleType', 'Kural tipi ara...')}
                  className={INPUT_STYLE}
                  modal={true}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="ruleCode"
          render={({ field }) => (
            <FormItem>
              <FormLabel className={LABEL_STYLE}>
                <Hash size={12} className="text-pink-500" />
                {t('pricingRule.header.ruleCode', 'Kural Kodu')} *
              </FormLabel>
              <FormControl>
                <Input
                  {...field}
                  placeholder={t('pricingRule.header.ruleCodePlaceholder', 'Kural kodu girin')}
                  maxLength={50}
                  className={INPUT_STYLE}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <div className="md:col-span-2">
          <FormField
            control={form.control}
            name="ruleName"
            render={({ field }) => (
              <FormItem>
                <FormLabel className={LABEL_STYLE}>
                  <Type size={12} className="text-pink-500" />
                  {t('pricingRule.header.ruleName', 'Kural Adı')} *
                </FormLabel>
                <FormControl>
                  <Input
                    {...field}
                    placeholder={t('pricingRule.header.ruleNamePlaceholder', 'Kural adı girin')}
                    maxLength={250}
                    className={INPUT_STYLE}
                  />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>
      </div>

      {/* 2. Tarih ve Müşteri */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
        <FormField
          control={form.control}
          name="validFrom"
          render={({ field }) => (
            <FormItem>
              <FormLabel className={LABEL_STYLE}>
                <Calendar size={12} className="text-pink-500" />
                {t('pricingRule.header.validFrom', 'Geçerlilik Başlangıç')} *
              </FormLabel>
              <FormControl>
                <Input
                  {...field}
                  type="date"
                  className={INPUT_STYLE}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="validTo"
          render={({ field }) => (
            <FormItem>
              <FormLabel className={LABEL_STYLE}>
                <Calendar size={12} className="text-pink-500" />
                {t('pricingRule.header.validTo', 'Geçerlilik Bitiş')} *
              </FormLabel>
              <FormControl>
                <Input
                  {...field}
                  type="date"
                  className={INPUT_STYLE}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <div className="md:col-span-2">
          <FormItem>
            <FormLabel className={LABEL_STYLE}>
              <Building2 size={12} className="text-pink-500" />
              {t('pricingRule.header.customer', 'Müşteri')}
            </FormLabel>
            <div className="flex gap-2">
              <Input
                readOnly
                value={displayValue}
                placeholder={t('pricingRule.header.customerPlaceholder', 'Müşteri seçin (Opsiyonel)')}
                className={`${INPUT_STYLE} flex-1`}
              />
              <Button
                type="button"
                variant="outline"
                size="icon"
                className="h-11 w-11 border-slate-200 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/5"
                onClick={() => setCustomerDialogOpen(true)}
                title={t('pricingRule.header.selectCustomer', 'Müşteri Seç')}
              >
                <Search className="h-4 w-4" />
              </Button>
              {(customerId || erpCustomerCode) && (
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  className="h-11 w-11 text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
                  onClick={() => {
                    form.setValue('customerId', null);
                    form.setValue('erpCustomerCode', null);
                  }}
                  title={t('pricingRule.header.clearCustomer', 'Müşteri Temizle')}
                >
                  <Search className="h-4 w-4 rotate-45" />
                </Button>
              )}
            </div>
          </FormItem>
        </div>
      </div>

      <CustomerSelectDialog
        open={customerDialogOpen}
        onOpenChange={setCustomerDialogOpen}
        onSelect={handleCustomerSelect}
      />
    </div>
  );
}
